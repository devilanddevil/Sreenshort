<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Time Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header class="header-flex">
            <div>
                <h1>Idle Time Tracker</h1>
                <p class="subtitle">Upload screenshots to track your idle minutes automatically.</p>
            </div>
            <div class="header-user-info">
                <span style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem;">Welcome, <strong>{{
                        current_user.username }}</strong></span>
                <div class="header-actions">
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('admin') }}"
                        style="color: var(--accent-color); text-decoration: none; font-weight: 500;">Admin Panel</a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}"
                        style="color: var(--text-secondary); text-decoration: none; font-size: 0.9rem;">Logout</a>
                </div>
            </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flashes">
            {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="stats-grid">
            <div class="card stat-card">
                <h2>Today's Idle Time</h2>
                <div class="value">{{ stats.today | format_minutes }}</div>
                <div class="sub-value" style="font-size: 1rem; color: var(--text-secondary); margin-top: 5px;">{{
                    stats.today }} mins</div>
            </div>
            <div class="card stat-card">
                <h2>Month's Idle Time</h2>
                <div class="value">{{ stats.month | format_minutes }}</div>
                <div class="sub-value" style="font-size: 1rem; color: var(--text-secondary); margin-top: 5px;">{{
                    stats.month }} mins</div>
            </div>
        </div>

        <div class="card upload-card" id="drop-zone">
            <h2>Upload Screenshot</h2>
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" class="upload-form"
                id="uploadForm">
                <input type="file" name="screenshot" id="file" accept="image/*">
                <label for="file" class="file-label" id="fileLabel">
                    <span class="icon">üìÅ</span>
                    <span>Choose a file, drag it here, or <strong>paste (Ctrl+V)</strong></span>
                </label>

                <div class="form-group upload-form-group">
                    <input type="number" name="manual_minutes" id="manual_minutes"
                        placeholder="Manual Minutes (optional)" class="input-reason" min="1"
                        style="flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-color); color: var(--text-primary);">

                    <input type="text" name="reason" placeholder="Enter reason (optional)" class="input-reason"
                        style="flex: 2; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-color); color: var(--text-primary);">
                </div>

                <div class="form-group upload-form-group" style="margin-top: 1rem;">
                    <label style="color: var(--text-secondary); font-size: 0.9rem; margin-right: 0.5rem;">Optional
                        Date:</label>
                    <input type="date" name="custom_date" class="input-reason"
                        style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-color); color: var(--text-primary); max-width: 200px;">
                </div>

                <div id="preview-container" style="display:none; margin-top: 1rem;">
                    <img id="image-preview"
                        style="max-width: 100%; border-radius: 8px; border: 1px solid var(--border-color);">
                </div>
                <button type="submit" class="btn-primary" id="submitBtn">Upload & Process</button>
            </form>
        </div>
        <!-- Recent Activity Table -->
        <div class="card">
            <div class="card-header card-header-flex">
                <div class="card-header-title-group">
                    <h2 style="margin: 0;">Recent Activity</h2>
                </div>
                <div class="card-header-actions">
                    <a href="{{ url_for('history') }}"
                        style="text-decoration: none; color: var(--accent-color); font-weight: 500;">View Full History
                        ‚Üí</a>
                    <a href="{{ url_for('export_excel') }}" class="btn-primary"
                        style="text-decoration: none; font-size: 0.9rem; padding: 0.5rem 1rem;">Download Excel üìä</a>
                </div>
            </div>
            <!-- AJAX Container -->
            <div id="data-container">
                {% with records=stats.recent.records,
                page=1,
                per_page=5,
                total_pages=0,
                endpoint='index',
                current_month=None %}
                {% include 'partials/table_content.html' %}
                {% endwith %}
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('file'); // Changed from 'screenshot-input' to 'file'
        const fileLabel = document.getElementById('fileLabel');
        const previewContainer = document.getElementById('preview-container');
        const imagePreview = document.getElementById('image-preview');
        const dropZone = document.getElementById('drop-zone');

        // Handle Paste
        window.addEventListener('paste', e => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    const file = new File([blob], "pasted_screenshot.png", { type: blob.type });

                    // Set input files
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;

                    // Update UI
                    showPreview(file);
                    updateLabel("Screenshot pasted!");
                }
            }
        });

        // Handle File Select
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                showPreview(file);
                updateLabel(file.name);
                document.getElementById('manual_minutes').value = ''; // Clear manual if file selected
            }
        });

        // Validation: Ensure either file or manual minutes
        document.getElementById('uploadForm').addEventListener('submit', function (e) {
            const file = fileInput.files.length;
            const manual = document.getElementById('manual_minutes').value;

            if (!file && !manual) {
                e.preventDefault();
                alert('Please either upload a screenshot OR enter manual minutes.');
            }
        });

        // Drag and Drop Visuals
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            document.querySelector('.upload-form').classList.add('highlight');
        }

        function unhighlight() {
            document.querySelector('.upload-form').classList.remove('highlight');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0 && files[0].type.startsWith('image/')) {
                fileInput.files = files;
                showPreview(files[0]);
                updateLabel(files[0].name);
            }
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                imagePreview.src = reader.result;
                previewContainer.style.display = 'block';
            }
        }

        function updateLabel(text) {
            fileLabel.querySelector('span:last-child').innerHTML = text;
            fileLabel.classList.add('file-selected');
        }
    </script>
    <script src="{{ url_for('static', filename='ajax.js') }}?v=3"></script>
</body>

</html>